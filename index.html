<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CS:GO Style Slot Machine — Alarmy Ruleta</title>
<link rel="stylesheet" href="slot.css">
</head>
<body>
<h1>Slot Machine de Canciones</h1>

<select id="categoriaSelect">
  <option value="Todas">Todas las categorías</option>
</select>

<div id="carouselWrap">
  <div id="carouselItems"></div>
</div>

<button id="spinBtn">Girar</button>
<div id="status">Cargando lista...</div>

<!-- Modal -->
<div id="modal">
  <div id="modalContent">
    <div id="modalLabel"></div>
    <button id="openLinkBtn">Abrir link</button>
  </div>
</div>

<script>
const REMOTE_JSON='';
const PALETTE_COLORS=['#8e44ad','#c0392b','#2980b9','#9b59b6','#e74c3c','#3498db'];

const q=s=>document.querySelector(s);
const carouselItems=q('#carouselItems');
const spinBtn=q('#spinBtn');
const status=q('#status');
const categoriaSelect=q('#categoriaSelect');
const modal=q('#modal');
const modalLabel=q('#modalLabel');
const openLinkBtn=q('#openLinkBtn');

let items=[];
let spinning=false;

async function tryLoad(){
  status.textContent='Cargando lista desde JSON...';
  const urlsToTry=[]; if(REMOTE_JSON) urlsToTry.push(REMOTE_JSON); urlsToTry.push('links.json');
  for(const u of urlsToTry){
    try{
      const res=await fetch(u,{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const parsed=await res.json();
      if(Array.isArray(parsed)&&parsed.length>0){
        items=parsed.map(it=>({
          label:String(it.label||'Sin nombre').trim(),
          artist:String(it.artist||'').trim(),
          url:String(it.url||'').trim(),
          img:String(it.img||'').trim(),
          categorias:Array.isArray(it.categorias)?it.categorias.map(c=>String(c)):[],
        })).filter(it=>it.url);
        updateCategoriaSelect();
        status.textContent=`Lista cargada — ${items.length} items`;
        renderCarousel(items);
        return;
      }
    }catch(e){ console.warn('No se pudo cargar JSON desde',u,e.message);}
  }
  status.textContent='No se encontró links.json';
}

function updateCategoriaSelect(){
  const categoriasUnicas=new Set();
  items.forEach(it=>it.categorias.forEach(c=>categoriasUnicas.add(c)));
  const opts=['<option value="Todas">Todas las categorías</option>'];
  Array.from(categoriasUnicas).sort().forEach(cat=>opts.push(`<option value="${cat}">${cat}</option>`));
  categoriaSelect.innerHTML=opts.join('');
}

function renderCarousel(list){
  carouselItems.innerHTML='';
  list.forEach(it=>{
    const div=document.createElement('div');
    div.className='carouselItem';
    div.innerHTML=`<img src="${it.img}" alt="${it.label}"/><div class="label">${it.label}<br/><span class="artist">${it.artist}</span></div>`;
    carouselItems.appendChild(div);
  });
}

function spinCarousel(){
  if(spinning) return;
  spinning=true;
  const sel=categoriaSelect.value;
  const filtered=sel==='Todas'?items:items.filter(it=>it.categorias.includes(sel));
  if(filtered.length===0){ alert('No hay links en esta categoría'); spinning=false; return; }

  const totalSteps=30+Math.floor(Math.random()*20);
  let step=0;

  const interval=setInterval(()=>{
    carouselItems.appendChild(carouselItems.children[0]); // mover primer elemento al final
    step++;
  },50);

  setTimeout(()=>{
    clearInterval(interval);
    spinning=false;
    const chosen=filtered[Math.floor(Math.random()*filtered.length)];
    modalLabel.textContent=chosen.label;
    modal.classList.add('active');
    createStars(50); createComets(3);
    openLinkBtn.onclick=()=>{
      modal.classList.remove('active');
      try{window.open(chosen.url,'_blank');}catch(e){location.href=chosen.url;}
      document.querySelectorAll('.star, .comet').forEach(e=>e.remove());
    };
  }, totalSteps*50+500);
}

// Estrellas y cometas
function createStars(count){for(let i=0;i<count;i++){const s=document.createElement('div');s.className='star';s.style.left=Math.random()*100+'vw';s.style.top=Math.random()*100+'vh';s.style.width=s.style.height=(Math.random()*2+1)+'px';s.style.animationDuration=(2+Math.random()*2)+'s';document.body.appendChild(s);}}
function createComets(count){for(let i=0;i<count;i++){const c=document.createElement('div');c.className='comet';c.style.top=Math.random()*50+'vh';c.style.animationDelay=(Math.random()*3)+'s';c.style.width=Math.random()*3+2+'px';document.body.appendChild(c);}}

spinBtn.addEventListener('click', spinCarousel);
categoriaSelect.addEventListener('change',()=>{renderCarousel(items);});

tryLoad();
</script>
</body>
</html>
